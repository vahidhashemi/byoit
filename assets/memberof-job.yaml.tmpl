apiVersion: batch/v1
kind: Job
metadata:
  name: {{.ReleaseName}}-memberof-setup
  namespace: {{.Namespace}}
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: memberof-setup
        image: osixia/openldap:1.5.0
        command: ["/bin/bash"]
        args:
        - -c
        - |
          set -e
          echo "Waiting for OpenLDAP to be ready..."
          until ldapsearch -x -H ldap://{{.ReleaseName}}-openldap:389 -D "cn=admin,{{.BaseDN}}" -w "{{.AdminPass}}" -b "{{.BaseDN}}" -s base >/dev/null 2>&1; do
            echo "Waiting for OpenLDAP..."
            sleep 5
          done
          
          echo "Enabling memberOf overlay..."
          ldapmodify -x -H ldap://{{.ReleaseName}}-openldap:389 -D "cn=admin,cn=config" -w "{{.ConfigPass}}" <<EOF
          dn: olcOverlay=memberof,olcDatabase={1}mdb,cn=config
          changetype: add
          objectClass: olcOverlayConfig
          objectClass: olcMemberOf
          olcOverlay: memberof
          olcMemberOfDangling: ignore
          olcMemberOfRefInt: TRUE
          olcMemberOfGroupOC: groupOfNames
          olcMemberOfMemberAD: member
          olcMemberOfMemberOfAD: memberOf
          EOF
          
          echo "Enabling refint overlay..."
          ldapmodify -x -H ldap://{{.ReleaseName}}-openldap:389 -D "cn=admin,cn=config" -w "{{.ConfigPass}}" <<EOF
          dn: olcOverlay=refint,olcDatabase={1}mdb,cn=config
          changetype: add
          objectClass: olcOverlayConfig
          objectClass: olcRefintConfig
          olcOverlay: refint
          olcRefintAttribute: memberof member manager owner
          EOF
          
          echo "memberOf and refint overlays enabled successfully!"
